# Eficy Core V3 - LLM æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

Eficy Core V3 æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„å‰ç«¯ç¼–æ’æ¡†æ¶ï¼Œé‡‡ç”¨å…¨æ–°çš„æŠ€æœ¯æ ˆå’Œæ¶æ„è®¾è®¡ï¼Œå®ç°é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„ JSON é©±åŠ¨ç»„ä»¶æ¸²æŸ“ã€‚

### æ ¸å¿ƒç‰¹æ€§
- ğŸ”„ åŸºäº @eficy/reactive çš„ç°ä»£åŒ–å“åº”å¼ç³»ç»Ÿï¼Œæ›¿ä»£ MobX
- ğŸ’‰ ä½¿ç”¨ tsyringe ä¾èµ–æ³¨å…¥å®¹å™¨ï¼Œå®ç°æ¾è€¦åˆæ¶æ„
- âš¡ ç‹¬ç«‹èŠ‚ç‚¹æ¸²æŸ“ï¼Œæ¯ä¸ª `#view` èŠ‚ç‚¹ä½¿ç”¨ React.memo å®Œå…¨éš”ç»çˆ¶å±‚ rerender
- ğŸ¯ æ”¯æŒä»»æ„ React ç»„ä»¶åº“ï¼Œæ— å¼ºä¾èµ–
- ğŸ”§ åŸºäºè£…é¥°å™¨çš„ç”Ÿå‘½å‘¨æœŸæ’ä»¶ç³»ç»Ÿ
- ğŸ“¦ TypeScript åŸç”Ÿæ”¯æŒï¼Œå®Œæ•´ç±»å‹å®šä¹‰
- ğŸ—ï¸ é¢å‘å¯¹è±¡è®¾è®¡ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤
- ğŸš€ ç”±å†…å‘å¤–æ¸²æŸ“ç­–ç•¥ï¼Œæå‡æ€§èƒ½

### æŠ€æœ¯æ ˆ
- React 18+
- TypeScript
- @eficy/reactive (åŸºäº @preact/signals-core)
- @eficy/reactive-react (React é›†æˆ)
- tsyringe (ä¾èµ–æ³¨å…¥)
- lodash (å·¥å…·åº“)
- nanoid (ID ç”Ÿæˆ)
- reflect-metadata (è£…é¥°å™¨æ”¯æŒ)

## æ ¸å¿ƒæ¶æ„

### 1. ä¸»è¦ç±»å’ŒæœåŠ¡

#### Eficy (æ ¸å¿ƒç±»)
```typescript
class Eficy {
  // é…ç½®æ–¹æ³•
  config(options: IEficyConfig): this
  extend(options: IExtendOptions): this
  
  // æ¸²æŸ“æ–¹æ³•
  async createElement(schema: IEficySchema): Promise<ReactElement | null>
  async render(schema: IEficySchema, container: string | HTMLElement): Promise<void>
  
  // èŠ‚ç‚¹æ“ä½œæ–¹æ³•
  getNodeTree(schema: IEficySchema): EficyModelTree
  findNode(nodeId: string): EficyNode | null
  updateNode(nodeId: string, data: any): void
  addChild(parentId: string, childData: any): EficyNode | null
  removeChild(parentId: string, childId: string): void
  
  // æ’ä»¶ç®¡ç†
  registerPlugin(plugin: ILifecyclePlugin): void
  unregisterPlugin(pluginName: string): void
  
  // ç»Ÿè®¡ä¿¡æ¯
  get stats(): object
}
```

#### EficyNode (æ•°æ®æ¨¡å‹)
```typescript
class EficyNode extends ObservableClass {
  // æ ¸å¿ƒå­—æ®µ
  @Observable public '#': string              // èŠ‚ç‚¹ID
  @Observable public '#view': string          // ç»„ä»¶åç§°
  @Observable public '#children': EficyNode[] // å­èŠ‚ç‚¹
  @Observable public '#content'?: string | ReactElement // å†…å®¹
  @Observable public '#if'?: boolean | (() => boolean)   // æ¡ä»¶æ¸²æŸ“
  @Observable public '#show'?: boolean | (() => boolean) // æ˜¾ç¤º/éšè—
  @Observable public '#style'?: Record<string, any>      // æ ·å¼
  @Observable public '#class'?: string | string[]        // CSSç±»å
  @Observable public '#events'?: Record<string, any>     // äº‹ä»¶å¤„ç†å™¨
  
  // è®¡ç®—å±æ€§
  @Computed get props(): Record<string, any>
  @Computed get shouldRender(): boolean
  @Computed get viewDataMap(): Record<string, EficyNode>
  
  // æ“ä½œæ–¹æ³•
  @Action updateField(key: string, value: any): void
  @Action addChild(child: EficyNode): void
  @Action removeChild(childId: string): void
  @Action update(data: IViewData): void
  @Action overwrite(data: IViewData): void
  
  // å·¥å…·æ–¹æ³•
  findChild(childId: string): EficyNode | null
  toJSON(): IViewData
  static fromJSON(data: IViewData): EficyNode
}
```

#### EficyModelTree (èŠ‚ç‚¹å­˜å‚¨)
```typescript
@injectable()
class EficyModelTree {
  @Observable private rootNode: EficyNode
  
  @Computed get nodeMap(): Record<string, EficyNode>
  @Computed get root(): EficyNode | null
  @Computed get nodes(): Record<string, EficyNode>
  @Computed get stats(): object
  
  @Action build(views: IViewData | IViewData[]): void
  findNode(nodeId: string): EficyNode | null
  @Action updateNode(nodeId: string, data: Partial<IViewData>): void
  @Action addChild(parentId: string, childData: IViewData): EficyNode | null
  @Action removeChild(parentId: string, childId: string): void
  @Action clear(): void
  
  toJSON(): IViewData | null
  static fromJSON(data: IViewData | IViewData[], pluginManager: PluginManager): EficyModelTree
}
```

#### DomTree (æ¸²æŸ“æ ‘)
```typescript
@injectable()
class DomTree {
  async createElement(eficyNode: EficyNode): Promise<void>
  findRenderNode(nodeId: string): ReactElement | null
  updateRenderNode(nodeId: string, eficyNode: EficyNode): void
  addRenderNode(eficyNode: EficyNode): void
  removeRenderNode(nodeId: string): void
  clear(): void
  get stats(): object
}
```

### 2. æœåŠ¡å±‚

#### ConfigService
```typescript
@injectable()
class ConfigService {
  get<T = any>(key: string): T
  set(key: string, value: any): void
  extend(options: IExtendOptions): void
  getConfig(): IEficyConfig
}
```

#### ComponentRegistry
```typescript
@injectable()
class ComponentRegistry implements IComponentRegistry {
  register(name: string, component: ComponentType<any> | string): void
  unregister(name: string): void
  get(name: string): ComponentType<any> | string | null
  getAll(): Record<string, ComponentType<any> | string>
  extend(componentMap: Record<string, ComponentType<any> | string>): void
}
```

#### PluginManager
```typescript
@injectable()
class PluginManager {
  register(plugin: ILifecyclePlugin): void
  unregister(pluginName: string): void
  async executeHook<T>(hookType: HookType, data: any, context: any, next: () => Promise<T>): Promise<T>
  getHookStats(): object
}
```

#### LifecycleEventEmitter
```typescript
@injectable()
class LifecycleEventEmitter {
  emit(event: string, data: any): void
  on(event: string, handler: Function): void
  off(event: string, handler: Function): void
  getStatistics(): object
}
```

## Schema æ ¼å¼

### åŸºç¡€ Schema ç»“æ„
```typescript
interface IViewData {
  '#'?: string                           // èŠ‚ç‚¹ID
  '#view'?: string                       // ç»„ä»¶åç§°ï¼Œé»˜è®¤ 'div'
  '#children'?: IViewData[]              // å­èŠ‚ç‚¹
  '#content'?: string | ReactElement     // æ–‡æœ¬å†…å®¹
  '#if'?: boolean | (() => boolean)      // æ¡ä»¶æ¸²æŸ“
  '#show'?: boolean | (() => boolean)    // æ˜¾ç¤º/éšè—
  '#style'?: Record<string, any>         // æ ·å¼
  '#class'?: string | string[]           // CSSç±»å
  '#events'?: Record<string, any>        // äº‹ä»¶å¤„ç†å™¨
  '#staticProps'?: Record<string, any>   // é™æ€å±æ€§
  [key: string]: any                     // å…¶ä»–åŠ¨æ€å±æ€§
}

interface IEficySchema {
  views: IViewData[]
  plugins?: IPlugin[]
  [key: string]: any
}
```

### Schema ç¤ºä¾‹

#### åŸºç¡€ç¤ºä¾‹
```typescript
const schema = {
  views: [
    {
      '#': 'welcome',
      '#view': 'div',
      className: 'welcome-container',
      '#children': [
        {
          '#': 'title',
          '#view': 'h1',
          '#content': 'Hello Eficy V3!',
          style: { color: 'blue' }
        },
        {
          '#': 'button',
          '#view': 'button',
          '#content': 'Click Me',
          onClick: () => console.log('Clicked!')
        }
      ]
    }
  ]
}
```

#### æ¡ä»¶æ¸²æŸ“ç¤ºä¾‹
```typescript
const conditionalSchema = {
  views: [
    {
      '#': 'greeting',
      '#view': 'div',
      '#if': () => new Date().getHours() < 12,
      '#content': 'æ—©ä¸Šå¥½ï¼'
    },
    {
      '#': 'afternoon-greeting',
      '#view': 'div',
      '#if': () => new Date().getHours() >= 12,
      '#content': 'ä¸‹åˆå¥½ï¼'
    }
  ]
}
```

#### è¡¨å•ç¤ºä¾‹
```typescript
const formSchema = {
  views: [
    {
      '#': 'user-form',
      '#view': 'Form',
      layout: 'vertical',
      '#children': [
        {
          '#': 'name-field',
          '#view': 'Form.Item',
          label: 'å§“å',
          '#children': [
            {
              '#': 'name-input',
              '#view': 'Input',
              placeholder: 'è¯·è¾“å…¥å§“å'
            }
          ]
        },
        {
          '#': 'submit-field',
          '#view': 'Form.Item',
          '#children': [
            {
              '#': 'submit-btn',
              '#view': 'Button',
              type: 'primary',
              htmlType: 'submit',
              '#content': 'æäº¤'
            }
          ]
        }
      ]
    }
  ]
}
```

## API ä½¿ç”¨æŒ‡å—

### 1. åˆ›å»ºå®ä¾‹
```typescript
import { Eficy } from '@eficy/core'

const eficy = new Eficy()
```

### 2. é…ç½®ç»„ä»¶åº“
```typescript
import { Button, Input, Form } from 'antd'

eficy.config({
  componentMap: {
    Button,
    Input,
    Form,
    'Form.Item': Form.Item
  }
})
```

### 3. æ‰©å±•é…ç½®
```typescript
// åŸºç¡€é…ç½®
eficy.config({
  componentMap: { Button, Input }
})

// æ‰©å±•é…ç½®ï¼ˆé€’å½’åˆå¹¶ï¼‰
eficy.extend({
  componentMap: { Form, Select }
})
```

### 4. æ¸²æŸ“ç»„ä»¶
```typescript
// åˆ›å»º React å…ƒç´ ï¼ˆå¼‚æ­¥ï¼‰
const element = await eficy.createElement(schema)

// ç›´æ¥æ¸²æŸ“åˆ° DOMï¼ˆå¼‚æ­¥ï¼‰
await eficy.render(schema, '#root')
// æˆ–
await eficy.render(schema, document.getElementById('root'))

// è·å–èŠ‚ç‚¹æ ‘
const nodeTree = eficy.getNodeTree(schema)

// æŸ¥æ‰¾å’Œæ“ä½œèŠ‚ç‚¹
const node = eficy.findNode('nodeId')
eficy.updateNode('nodeId', { text: 'Updated' })
eficy.addChild('parentId', { '#view': 'span', '#content': 'New child' })
eficy.removeChild('parentId', 'childId')
```

## å“åº”å¼æ•°æ®

### ä½¿ç”¨ EficyNode æ„å»ºå“åº”å¼æ•°æ®
```typescript
import { EficyNode } from '@eficy/core'

// åˆ›å»ºå“åº”å¼è§†å›¾èŠ‚ç‚¹
const eficyNode = new EficyNode({
  '#': 'counter',
  '#view': 'div',
  count: 0,
  '#style': { padding: '10px' },
  '#class': 'counter-container'
})

// å“åº”å¼æ›´æ–°
eficyNode.updateField('count', 10)
eficyNode.updateField('#content', 'Count: 10')
eficyNode.updateField('#style', { padding: '20px', color: 'blue' })

// æ·»åŠ å­èŠ‚ç‚¹
const child = new EficyNode({
  '#': 'display',
  '#view': 'span',
  '#content': 'Count: 10'
})
eficyNode.addChild(child)

// æ¡ä»¶æ¸²æŸ“
eficyNode.updateField('#if', () => eficyNode.props.count > 0)
eficyNode.updateField('#show', true)

// åºåˆ—åŒ–
const json = eficyNode.toJSON()
console.log(json)
```

### è®¡ç®—å±æ€§å’ŒåŠ¨ä½œ
```typescript
import { Observable, Computed, Action, ObservableClass } from '@eficy/reactive'

class CounterStore extends ObservableClass {
  @Observable count = 0
  
  @Computed get isEven() {
    return this.count % 2 === 0
  }
  
  @Action increment() {
    this.count++
  }
  
  @Action reset() {
    this.count = 0
  }
}
```

## ç»„ä»¶æ³¨å†Œ

### è‡ªåŠ¨æ³¨å†Œçš„ HTML æ ‡ç­¾
```typescript
// ä»¥ä¸‹æ ‡ç­¾è‡ªåŠ¨æ³¨å†Œï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
const htmlTags = [
  'div', 'span', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
  'button', 'input', 'textarea', 'select', 'option',
  'ul', 'ol', 'li', 'dl', 'dt', 'dd',
  'table', 'thead', 'tbody', 'tr', 'th', 'td',
  'form', 'label', 'fieldset', 'legend',
  'a', 'img', 'video', 'audio', 'canvas',
  'section', 'article', 'aside', 'header', 'footer', 'nav', 'main',
  'strong', 'em', 'small', 'code', 'pre', 'blockquote',
  'hr', 'br'
]

// ç‰¹æ®Šç»„ä»¶
// Fragment å’Œ <> ä¹Ÿè‡ªåŠ¨æ³¨å†Œ
```

### æ³¨å†Œè‡ªå®šä¹‰ç»„ä»¶
```typescript
import { MyCustomComponent } from './components'

// å•ä¸ªæ³¨å†Œ
eficy.config({
  componentMap: {
    'MyCustom': MyCustomComponent
  }
})

// æ‰¹é‡æ³¨å†Œ
const componentMap = {
  'Header': HeaderComponent,
  'Footer': FooterComponent,
  'Navigation': NavigationComponent
}
eficy.extend({ componentMap })
```

## æ’ä»¶ç³»ç»Ÿ

### ç”Ÿå‘½å‘¨æœŸæ’ä»¶æ¥å£
```typescript
interface ILifecyclePlugin extends IEficyPlugin {
  name: string
  version: string
  dependencies?: string[]
  enforce?: 'pre' | 'post' | undefined  // æ‰§è¡Œé¡ºåº
  
  // ç”Ÿå‘½å‘¨æœŸé’©å­
  onInit?(context: IInitContext, next: () => Promise<void>): Promise<void>
  onBuildSchemaNode?(viewData: IViewData, context: IBuildSchemaNodeContext, next: () => Promise<EficyNode>): Promise<EficyNode>
  onRender?(viewNode: EficyNode, context: IRenderContext, next: () => Promise<ReactElement>): Promise<ReactElement>
  onMount?(element: Element, viewNode: EficyNode, context: IMountContext, next: () => Promise<void>): Promise<void>
  onUnmount?(element: Element, viewNode: EficyNode, context: IUnmountContext, next: () => Promise<void>): Promise<void>
  onResolveComponent?(componentName: string, viewNode: EficyNode, context: IResolveComponentContext, next: () => Promise<ComponentType>): Promise<ComponentType>
  onProcessProps?(props: Record<string, any>, viewNode: EficyNode, context: IProcessPropsContext, next: () => Promise<Record<string, any>>): Promise<Record<string, any>>
  onHandleEvent?(event: Event, viewNode: EficyNode, context: IHandleEventContext, next: () => Promise<any>): Promise<any>
  onBindEvent?(eventName: string, handler: Function, viewNode: EficyNode, context: IBindEventContext, next: () => Promise<void>): Promise<void>
  onError?(error: Error, viewNode: EficyNode | null, context: IErrorContext, next: () => Promise<ReactElement | void>): Promise<ReactElement | void>
}
```

### æ’ä»¶ç¤ºä¾‹
```typescript
class MyPlugin implements ILifecyclePlugin {
  name = 'MyPlugin'
  version = '1.0.0'
  enforce = 'pre' // ä¼˜å…ˆæ‰§è¡Œ
  
  async onInit(context: IInitContext, next: () => Promise<void>) {
    console.log('Plugin initializing...')
    await next()
    console.log('Plugin initialized')
  }
  
  async onBuildSchemaNode(
    viewData: IViewData, 
    context: IBuildSchemaNodeContext, 
    next: () => Promise<EficyNode>
  ): Promise<EficyNode> {
    // ä¿®æ”¹æˆ–éªŒè¯ ViewData
    console.log('Building node:', viewData['#view'])
    const node = await next()
    // åå¤„ç†èŠ‚ç‚¹
    return node
  }
  
  async onProcessProps(
    props: Record<string, any>,
    viewNode: EficyNode,
    context: IProcessPropsContext,
    next: () => Promise<Record<string, any>>
  ): Promise<Record<string, any>> {
    // å¤„ç†å±æ€§
    const processedProps = await next()
    return {
      ...processedProps,
      'data-plugin': 'MyPlugin'
    }
  }
}
```

### æ³¨å†Œæ’ä»¶
```typescript
const eficy = new Eficy()
const plugin = new MyPlugin()

// æ³¨å†Œæ’ä»¶
eficy.registerPlugin(plugin)

// å¸è½½æ’ä»¶
eficy.unregisterPlugin('MyPlugin')

// è·å–æ’ä»¶ç®¡ç†å™¨
const pluginManager = eficy.getPluginManager()
console.log(pluginManager.getHookStats())
```

## æ€§èƒ½ä¼˜åŒ–

### 1. React.memo ä¼˜åŒ–
- æ¯ä¸ª ViewNode æ¸²æŸ“ä¸ºç‹¬ç«‹çš„ RenderNode
- ä½¿ç”¨ React.memo é˜²æ­¢ä¸å¿…è¦çš„é‡æ¸²æŸ“
- æ¯”è¾ƒç­–ç•¥åŸºäº ViewNode å®ä¾‹å¼•ç”¨

### 2. å“åº”å¼æ›´æ–°
- ç»†ç²’åº¦çš„å“åº”å¼æ›´æ–°
- åªæœ‰ä¾èµ–çš„ ViewNode å˜æ›´æ—¶æ‰é‡æ–°æ¸²æŸ“
- æ‰¹å¤„ç†å¤šä¸ªæ›´æ–°æ“ä½œ

### 3. ç»„ä»¶éš”ç¦»
- ErrorBoundary åŒ…è£…ç¡®ä¿é”™è¯¯éš”ç¦»
- ç‹¬ç«‹çš„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†

## æµ‹è¯•

### å•å…ƒæµ‹è¯•ç¤ºä¾‹
```typescript
import { describe, it, expect } from 'vitest'
import { EficyNode, Eficy } from '@eficy/core'

describe('EficyNode', () => {
  it('should create reactive eficy node', () => {
    const eficyNode = new EficyNode({
      '#': 'test',
      '#view': 'div',
      className: 'test-class'
    })
    
    expect(eficyNode['#']).toBe('test')
    expect(eficyNode['#view']).toBe('div')
    expect(eficyNode.props.className).toBe('test-class')
  })
  
  it('should update field reactively', () => {
    const eficyNode = new EficyNode({
      '#': 'test',
      '#view': 'div'
    })
    
    eficyNode.updateField('title', 'New Title')
    expect(eficyNode.props.title).toBe('New Title')
  })
  
  it('should handle conditional rendering', () => {
    const eficyNode = new EficyNode({
      '#': 'test',
      '#view': 'div',
      '#if': () => false
    })
    
    expect(eficyNode.shouldRender).toBe(false)
    
    eficyNode.updateField('#if', true)
    expect(eficyNode.shouldRender).toBe(true)
  })
  
  it('should serialize to JSON', () => {
    const eficyNode = new EficyNode({
      '#': 'test',
      '#view': 'Button',
      type: 'primary',
      '#content': 'Click me'
    })
    
    const json = eficyNode.toJSON()
    expect(json).toEqual({
      '#': 'test',
      '#view': 'Button',
      type: 'primary',
      '#content': 'Click me'
    })
  })
})
```

### é›†æˆæµ‹è¯•ç¤ºä¾‹
```typescript
import { render, screen } from '@testing-library/react'
import { Eficy } from '@eficy/core'

describe('Eficy Integration', () => {
  it('should render schema correctly', async () => {
    const eficy = new Eficy()
    const schema = {
      views: [
        {
          '#': 'greeting',
          '#view': 'h1',
          '#content': 'Hello World'
        }
      ]
    }
    
    const element = await eficy.createElement(schema)
    render(element)
    
    expect(screen.getByRole('heading')).toHaveTextContent('Hello World')
  })
  
  it('should handle node updates', async () => {
    const eficy = new Eficy()
    const schema = {
      views: [
        {
          '#': 'counter',
          '#view': 'div',
          '#content': 'Count: 0'
        }
      ]
    }
    
    await eficy.createElement(schema)
    
    // æ›´æ–°èŠ‚ç‚¹
    eficy.updateNode('counter', { '#content': 'Count: 1' })
    
    const node = eficy.findNode('counter')
    expect(node?.props.children).toBe('Count: 1')
  })
})
```

## é”™è¯¯å¤„ç†

### ErrorBoundary
- æ¯ä¸ª RenderNode éƒ½åŒ…å« ErrorBoundary
- æ•è·ç»„ä»¶æ¸²æŸ“é”™è¯¯ï¼Œé˜²æ­¢æ•´ä¸ªåº”ç”¨å´©æºƒ
- æä¾›é”™è¯¯ä¿¡æ¯å’Œæ¢å¤æœºåˆ¶

### å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

#### 1. ç»„ä»¶æœªæ‰¾åˆ°
```typescript
// é”™è¯¯ï¼šComponent "MyButton" not found in componentMap
// è§£å†³ï¼šæ³¨å†Œç»„ä»¶
eficy.config({
  componentMap: {
    'MyButton': MyButtonComponent
  }
})
```

#### 2. æ¨¡å—å¯¼å…¥é”™è¯¯
```typescript
// é”™è¯¯ï¼šCannot find module '@eficy/core'
// è§£å†³ï¼šç¡®ä¿æ­£ç¡®å®‰è£…ä¾èµ–
npm install @eficy/core @eficy/reactive @eficy/reactive-react
```

#### 3. ç±»å‹é”™è¯¯
```typescript
// é”™è¯¯ï¼šType 'string' is not assignable to type 'ReactElement'
// è§£å†³ï¼šæ£€æŸ¥ Schema ä¸­çš„ '#content' ç±»å‹
{
  '#content': 'Text content' // âœ… æ­£ç¡®
  // '#content': <Component /> // âœ… ä¹Ÿæ­£ç¡®
}
```

#### 4. å¼‚æ­¥æ–¹æ³•è°ƒç”¨é”™è¯¯
```typescript
// é”™è¯¯ï¼šæœªç­‰å¾…å¼‚æ­¥æ–¹æ³•
const element = eficy.createElement(schema) // âŒ é”™è¯¯

// æ­£ç¡®ï¼šä½¿ç”¨ await
const element = await eficy.createElement(schema) // âœ… æ­£ç¡®
```

#### 5. ä¾èµ–æ³¨å…¥é”™è¯¯
```typescript
// é”™è¯¯ï¼šreflect-metadata æœªå¯¼å…¥
// è§£å†³ï¼šåœ¨å…¥å£æ–‡ä»¶é¡¶éƒ¨å¯¼å…¥
import 'reflect-metadata'
```

## è¿ç§»æŒ‡å—

### ä» V2 è¿ç§»åˆ° V3

#### 1. ä¾èµ–æ›´æ–°
```json
// package.json
{
  "dependencies": {
    "@eficy/core": "^3.0.0",
    "@eficy/reactive": "^1.0.0",
    "@eficy/reactive-react": "^1.0.0",
    "tsyringe": "^4.8.0",
    "reflect-metadata": "^0.2.2"
  }
}
```

#### 2. å¯¼å…¥æ›´æ–°
```typescript
// V2
import { Controller } from '@eficy/core-v2'

// V3
import { Eficy } from '@eficy/core'
```

#### 3. å®ä¾‹åŒ–æ›´æ–°
```typescript
// V2
const controller = new Controller(schema)

// V3
const eficy = new Eficy()
const element = eficy.createElement(schema)
```

#### 4. å“åº”å¼æ•°æ®æ›´æ–°
```typescript
// V2 (MobX)
import { Observable, Computed, Action } from 'mobx'

// V3 (@eficy/reactive)
import { Observable, Computed, Action, ObservableClass } from '@eficy/reactive'

class Store extends ObservableClass {
  @Observable data = []
  
  @Action updateData(newData) {
    // V2: ç›´æ¥ä¿®æ”¹
    this.data.push(newData)
    
    // V3: ä¸å¯å˜æ›´æ–°ï¼ˆæ¨èï¼‰
    this.data = [...this.data, newData]
  }
}
```

#### 5. API æ–¹æ³•æ›´æ–°
```typescript
// V2
const controller = new Controller(schema)
const element = controller.createElement() // åŒæ­¥

// V3
const eficy = new Eficy()
const element = await eficy.createElement(schema) // å¼‚æ­¥
```

#### 6. èŠ‚ç‚¹æ¨¡å‹æ›´æ–°
```typescript
// V2: ViewNode
import { ViewNode } from '@eficy/core-v2'

// V3: EficyNode
import { EficyNode } from '@eficy/core'

// V2
const viewNode = new ViewNode(data)

// V3
const eficyNode = new EficyNode(data)
```

## æœ€ä½³å®è·µ

### 1. Schema è®¾è®¡
- ä½¿ç”¨æœ‰æ„ä¹‰çš„èŠ‚ç‚¹ ID (`'#'` å­—æ®µ)
- ä¿æŒ Schema ç»“æ„æ¸…æ™°å’Œå±‚æ¬¡åŒ–
- åˆç†ä½¿ç”¨æ¡ä»¶æ¸²æŸ“é¿å…å¤æ‚åµŒå¥—

### 2. ç»„ä»¶æ³¨å†Œ
- ç»Ÿä¸€çš„ç»„ä»¶å‘½åçº¦å®š
- æŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡ç»„ä»¶
- ä½¿ç”¨ TypeScript ç±»å‹å®šä¹‰

### 3. æ€§èƒ½ä¼˜åŒ–
- é¿å…åœ¨ `'#if'` ä¸­è¿›è¡Œå¤æ‚è®¡ç®—
- ä½¿ç”¨è®¡ç®—å±æ€§ç¼“å­˜æ˜‚è´µæ“ä½œ
- åˆç†æ‹†åˆ†å¤§å‹ Schema

### 4. é”™è¯¯å¤„ç†
- æ€»æ˜¯æä¾› fallback ç»„ä»¶
- ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼
- æ·»åŠ é€‚å½“çš„é”™è¯¯è¾¹ç•Œ

## å¼€å‘å·¥å…·

### è°ƒè¯•
- React DevTools æŸ¥çœ‹ç»„ä»¶æ ‘
- æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ ViewNode çŠ¶æ€
- ä½¿ç”¨ `effect` è·Ÿè¸ªå“åº”å¼å˜åŒ–

### æ€§èƒ½åˆ†æ
- React Profiler åˆ†ææ¸²æŸ“æ€§èƒ½
- è§‚å¯Ÿ ViewNode æ›´æ–°é¢‘ç‡
- æ£€æŸ¥ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“

## ç¤ºä¾‹é¡¹ç›®

### Playground
```bash
cd playground
npm run dev:v3
# è®¿é—® http://localhost:9899
```

### å®Œæ•´åº”ç”¨ç¤ºä¾‹
å‚è€ƒ `playground/src/main-v3.tsx` æŸ¥çœ‹å®Œæ•´çš„åº”ç”¨ç¤ºä¾‹ï¼ŒåŒ…å«ï¼š
- åŸºç¡€ç»„ä»¶ä½¿ç”¨
- å“åº”å¼æ•°æ®æ¼”ç¤º
- è¡¨å•å¤„ç†
- æ¡ä»¶æ¸²æŸ“
- ç»„ä»¶åº“é›†æˆ

---

æ­¤æ–‡æ¡£ä¸º Eficy Core V3 çš„å®Œæ•´ LLM å‚è€ƒæ–‡æ¡£ï¼Œæ¶µç›–äº†æ¶æ„ã€APIã€ä½¿ç”¨æ–¹æ³•ã€æœ€ä½³å®è·µç­‰æ‰€æœ‰é‡è¦ä¿¡æ¯ã€‚ 