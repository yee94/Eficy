# Eficy Core V3 - LLM Documentation

## é¡¹ç›®æ¦‚è¿°

Eficy Core V3 æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„å£°æ˜å¼ UI æ¡†æ¶ï¼ŒåŸºäº React æ„å»ºï¼Œé‡‡ç”¨ Schema é©±åŠ¨çš„æ–¹å¼ç”Ÿæˆç”¨æˆ·ç•Œé¢ã€‚

### æ ¸å¿ƒç‰¹æ€§
- ğŸ”„ åŸºäº @eficy/reactive çš„ç°ä»£åŒ–å“åº”å¼ç³»ç»Ÿ
- ğŸ’‰ ä½¿ç”¨ tsyringe ä¾èµ–æ³¨å…¥å®¹å™¨
- âš¡ React.memo ä¼˜åŒ–çš„ç‹¬ç«‹èŠ‚ç‚¹æ¸²æŸ“
- ğŸ¯ æ”¯æŒä»»æ„ React ç»„ä»¶åº“
- ğŸ”§ å¯æ‰©å±•çš„æ’ä»¶ç³»ç»Ÿ
- ğŸ“¦ TypeScript åŸç”Ÿæ”¯æŒ

### æŠ€æœ¯æ ˆ
- React 18+
- TypeScript
- @eficy/reactive (åŸºäº @preact/signals-core)
- tsyringe (ä¾èµ–æ³¨å…¥)
- ahooks (React Hooks)
- lodash (å·¥å…·åº“)
- nanoid (ID ç”Ÿæˆ)

## æ ¸å¿ƒæ¶æ„

### 1. ä¸»è¦ç±»å’ŒæœåŠ¡

#### Eficy (æ ¸å¿ƒç±»)
```typescript
class Eficy {
  config(options: IEficyConfig): this
  extend(options: IExtendOptions): this
  createElement(schema: IEficySchema): ReactElement | null
  render(schema: IEficySchema, container: string | HTMLElement): void
}
```

#### ViewNode (æ•°æ®æ¨¡å‹)
```typescript
class ViewNode extends ObservableClass {
  public readonly id: string
  @observable public '#': string
  @observable public '#view': string
  @observable public '#children': ViewNode[]
  @observable public '#content'?: string | ReactElement
  @observable public '#if'?: boolean | (() => boolean)
  
  @computed get props(): Record<string, any>
  @computed get shouldRender(): boolean
  
  @action updateField(key: string, value: any): void
  @action addChild(child: ViewNode): void
  @action removeChild(childId: string): void
}
```

#### RenderNode (æ¸²æŸ“ç»„ä»¶)
```typescript
const RenderNode = memo<IRenderNodeProps>((props) => {
  return (
    <ErrorBoundary>
      <RenderNodeInner {...props} />
    </ErrorBoundary>
  )
})
```

### 2. æœåŠ¡å±‚

#### ConfigService
```typescript
@injectable()
class ConfigService implements IConfigService {
  get<T = any>(key: string): T
  set(key: string, value: any): void
  extend(options: IExtendOptions): void
  getConfig(): IEficyConfig
}
```

#### ComponentRegistry
```typescript
@injectable()
class ComponentRegistry implements IComponentRegistry {
  register(name: string, component: ComponentType<any> | string): void
  unregister(name: string): void
  get(name: string): ComponentType<any> | string | null
  extend(componentMap: Record<string, ComponentType<any> | string>): void
}
```

#### LifecycleManager
```typescript
@injectable()
class LifecycleManager implements ILifecycleManager {
  register(phase: string, target: any, method: string): void
  async execute(phase: string, context: ILifecycleContext): Promise<void>
  hasHooks(phase: string): boolean
}
```

## Schema æ ¼å¼

### åŸºç¡€ Schema ç»“æ„
```typescript
interface IViewData {
  '#'?: string                    // èŠ‚ç‚¹ID
  '#view': string                 // ç»„ä»¶åç§°
  '#children'?: IViewData[]       // å­èŠ‚ç‚¹
  '#content'?: string | ReactElement // æ–‡æœ¬å†…å®¹
  '#if'?: boolean | (() => boolean)   // æ¡ä»¶æ¸²æŸ“
  [key: string]: any              // å…¶ä»–å±æ€§
}

interface IEficySchema {
  views: IViewData[]
}
```

### Schema ç¤ºä¾‹

#### åŸºç¡€ç¤ºä¾‹
```typescript
const schema = {
  views: [
    {
      '#': 'welcome',
      '#view': 'div',
      className: 'welcome-container',
      '#children': [
        {
          '#': 'title',
          '#view': 'h1',
          '#content': 'Hello Eficy V3!',
          style: { color: 'blue' }
        },
        {
          '#': 'button',
          '#view': 'button',
          '#content': 'Click Me',
          onClick: () => console.log('Clicked!')
        }
      ]
    }
  ]
}
```

#### æ¡ä»¶æ¸²æŸ“ç¤ºä¾‹
```typescript
const conditionalSchema = {
  views: [
    {
      '#': 'greeting',
      '#view': 'div',
      '#if': () => new Date().getHours() < 12,
      '#content': 'æ—©ä¸Šå¥½ï¼'
    },
    {
      '#': 'afternoon-greeting',
      '#view': 'div',
      '#if': () => new Date().getHours() >= 12,
      '#content': 'ä¸‹åˆå¥½ï¼'
    }
  ]
}
```

#### è¡¨å•ç¤ºä¾‹
```typescript
const formSchema = {
  views: [
    {
      '#': 'user-form',
      '#view': 'Form',
      layout: 'vertical',
      '#children': [
        {
          '#': 'name-field',
          '#view': 'Form.Item',
          label: 'å§“å',
          '#children': [
            {
              '#': 'name-input',
              '#view': 'Input',
              placeholder: 'è¯·è¾“å…¥å§“å'
            }
          ]
        },
        {
          '#': 'submit-field',
          '#view': 'Form.Item',
          '#children': [
            {
              '#': 'submit-btn',
              '#view': 'Button',
              type: 'primary',
              htmlType: 'submit',
              '#content': 'æäº¤'
            }
          ]
        }
      ]
    }
  ]
}
```

## API ä½¿ç”¨æŒ‡å—

### 1. åˆ›å»ºå®ä¾‹
```typescript
import { Eficy } from '@eficy/core-v3'

const eficy = new Eficy()
```

### 2. é…ç½®ç»„ä»¶åº“
```typescript
import { Button, Input, Form } from 'antd'

eficy.config({
  componentMap: {
    Button,
    Input,
    Form,
    'Form.Item': Form.Item
  }
})
```

### 3. æ‰©å±•é…ç½®
```typescript
// åŸºç¡€é…ç½®
eficy.config({
  componentMap: { Button, Input }
})

// æ‰©å±•é…ç½®ï¼ˆé€’å½’åˆå¹¶ï¼‰
eficy.extend({
  componentMap: { Form, Select }
})
```

### 4. æ¸²æŸ“ç»„ä»¶
```typescript
// åˆ›å»º React å…ƒç´ 
const element = eficy.createElement(schema)

// ç›´æ¥æ¸²æŸ“åˆ° DOM
eficy.render(schema, '#root')
// æˆ–
eficy.render(schema, document.getElementById('root'))
```

## å“åº”å¼æ•°æ®

### ä½¿ç”¨ ViewNode æ„å»ºå“åº”å¼æ•°æ®
```typescript
import { ViewNode } from '@eficy/core-v3'

// åˆ›å»ºå“åº”å¼è§†å›¾èŠ‚ç‚¹
const viewNode = new ViewNode({
  '#': 'counter',
  '#view': 'div',
  count: 0
})

// å“åº”å¼æ›´æ–°
viewNode.updateField('count', 10)

// æ·»åŠ å­èŠ‚ç‚¹
const child = new ViewNode({
  '#': 'display',
  '#view': 'span',
  '#content': 'Count: 10'
})
viewNode.addChild(child)
```

### è®¡ç®—å±æ€§å’ŒåŠ¨ä½œ
```typescript
import { observable, computed, action, ObservableClass } from '@eficy/reactive'

class CounterStore extends ObservableClass {
  @observable count = 0
  
  @computed get isEven() {
    return this.count % 2 === 0
  }
  
  @action increment() {
    this.count++
  }
  
  @action reset() {
    this.count = 0
  }
}
```

## ç»„ä»¶æ³¨å†Œ

### è‡ªåŠ¨æ³¨å†Œçš„ HTML æ ‡ç­¾
```typescript
// ä»¥ä¸‹æ ‡ç­¾è‡ªåŠ¨æ³¨å†Œï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
const htmlTags = [
  'div', 'span', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
  'button', 'input', 'textarea', 'select', 'option',
  'form', 'label', 'fieldset', 'legend',
  'table', 'thead', 'tbody', 'tr', 'td', 'th',
  'ul', 'ol', 'li', 'dl', 'dt', 'dd',
  'img', 'a', 'br', 'hr', 'strong', 'em', 'code', 'pre'
]
```

### æ³¨å†Œè‡ªå®šä¹‰ç»„ä»¶
```typescript
import { MyCustomComponent } from './components'

// å•ä¸ªæ³¨å†Œ
eficy.config({
  componentMap: {
    'MyCustom': MyCustomComponent
  }
})

// æ‰¹é‡æ³¨å†Œ
const componentMap = {
  'Header': HeaderComponent,
  'Footer': FooterComponent,
  'Navigation': NavigationComponent
}
eficy.extend({ componentMap })
```

## æ’ä»¶ç³»ç»Ÿ

### ç”Ÿå‘½å‘¨æœŸè£…é¥°å™¨
```typescript
class MyPlugin {
  @Init
  async initialize(context: IInitContext, next: () => Promise<void>) {
    console.log('Plugin initializing...')
    await next()
    console.log('Plugin initialized')
  }
  
  @BuildViewNode
  async processViewNode(context: IBuildViewNodeContext, next: () => Promise<void>) {
    // ä¿®æ”¹æˆ–éªŒè¯ ViewNode
    await next()
  }
}
```

### æ³¨å†Œæ’ä»¶
```typescript
import { container } from 'tsyringe'
import { LifecycleManager } from '@eficy/core-v3'

const lifecycleManager = container.resolve(LifecycleManager)
const plugin = new MyPlugin()

lifecycleManager.register('init', plugin, 'initialize')
lifecycleManager.register('buildViewNode', plugin, 'processViewNode')
```

## æ€§èƒ½ä¼˜åŒ–

### 1. React.memo ä¼˜åŒ–
- æ¯ä¸ª ViewNode æ¸²æŸ“ä¸ºç‹¬ç«‹çš„ RenderNode
- ä½¿ç”¨ React.memo é˜²æ­¢ä¸å¿…è¦çš„é‡æ¸²æŸ“
- æ¯”è¾ƒç­–ç•¥åŸºäº ViewNode å®ä¾‹å¼•ç”¨

### 2. å“åº”å¼æ›´æ–°
- ç»†ç²’åº¦çš„å“åº”å¼æ›´æ–°
- åªæœ‰ä¾èµ–çš„ ViewNode å˜æ›´æ—¶æ‰é‡æ–°æ¸²æŸ“
- æ‰¹å¤„ç†å¤šä¸ªæ›´æ–°æ“ä½œ

### 3. ç»„ä»¶éš”ç¦»
- ErrorBoundary åŒ…è£…ç¡®ä¿é”™è¯¯éš”ç¦»
- ç‹¬ç«‹çš„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†

## æµ‹è¯•

### å•å…ƒæµ‹è¯•ç¤ºä¾‹
```typescript
import { describe, it, expect } from 'vitest'
import { ViewNode, Eficy } from '@eficy/core-v3'

describe('ViewNode', () => {
  it('should create reactive view node', () => {
    const viewNode = new ViewNode({
      '#': 'test',
      '#view': 'div',
      className: 'test-class'
    })
    
    expect(viewNode['#']).toBe('test')
    expect(viewNode['#view']).toBe('div')
    expect(viewNode.props.className).toBe('test-class')
  })
  
  it('should update field reactively', () => {
    const viewNode = new ViewNode({
      '#': 'test',
      '#view': 'div'
    })
    
    viewNode.updateField('title', 'New Title')
    expect(viewNode.props.title).toBe('New Title')
  })
})
```

### é›†æˆæµ‹è¯•ç¤ºä¾‹
```typescript
import { render, screen } from '@testing-library/react'
import { Eficy } from '@eficy/core-v3'

describe('Eficy Integration', () => {
  it('should render schema correctly', () => {
    const eficy = new Eficy()
    const schema = {
      views: [
        {
          '#': 'greeting',
          '#view': 'h1',
          '#content': 'Hello World'
        }
      ]
    }
    
    const element = eficy.createElement(schema)
    render(element)
    
    expect(screen.getByRole('heading')).toHaveTextContent('Hello World')
  })
})
```

## é”™è¯¯å¤„ç†

### ErrorBoundary
- æ¯ä¸ª RenderNode éƒ½åŒ…å« ErrorBoundary
- æ•è·ç»„ä»¶æ¸²æŸ“é”™è¯¯ï¼Œé˜²æ­¢æ•´ä¸ªåº”ç”¨å´©æºƒ
- æä¾›é”™è¯¯ä¿¡æ¯å’Œæ¢å¤æœºåˆ¶

### å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

#### 1. ç»„ä»¶æœªæ‰¾åˆ°
```typescript
// é”™è¯¯ï¼šComponent "MyButton" not found in componentMap
// è§£å†³ï¼šæ³¨å†Œç»„ä»¶
eficy.config({
  componentMap: {
    'MyButton': MyButtonComponent
  }
})
```

#### 2. æ¨¡å—å¯¼å…¥é”™è¯¯
```typescript
// é”™è¯¯ï¼šCannot find module '@eficy/core-v3'
// è§£å†³ï¼šç¡®ä¿æ­£ç¡®å®‰è£…ä¾èµ–
npm install @eficy/core-v3
```

#### 3. ç±»å‹é”™è¯¯
```typescript
// é”™è¯¯ï¼šType 'string' is not assignable to type 'ReactElement'
// è§£å†³ï¼šæ£€æŸ¥ Schema ä¸­çš„ '#content' ç±»å‹
{
  '#content': 'Text content' // âœ… æ­£ç¡®
  // '#content': <Component /> // âœ… ä¹Ÿæ­£ç¡®
}
```

## è¿ç§»æŒ‡å—

### ä» V2 è¿ç§»åˆ° V3

#### 1. ä¾èµ–æ›´æ–°
```json
// package.json
{
  "dependencies": {
    "@eficy/core-v3": "^3.0.0",
    "@eficy/reactive": "^1.0.0",
    "@eficy/reactive-react": "^1.0.0",
    "tsyringe": "^4.8.0",
    "reflect-metadata": "^0.2.2"
  }
}
```

#### 2. å¯¼å…¥æ›´æ–°
```typescript
// V2
import { Controller } from '@eficy/core-v2'

// V3
import { Eficy } from '@eficy/core-v3'
```

#### 3. å®ä¾‹åŒ–æ›´æ–°
```typescript
// V2
const controller = new Controller(schema)

// V3
const eficy = new Eficy()
const element = eficy.createElement(schema)
```

#### 4. å“åº”å¼æ•°æ®æ›´æ–°
```typescript
// V2 (MobX)
import { observable, computed, action } from 'mobx'

// V3 (@eficy/reactive)
import { observable, computed, action, ObservableClass } from '@eficy/reactive'

class Store extends ObservableClass {
  @observable data = []
  
  @action updateData(newData) {
    // V2: ç›´æ¥ä¿®æ”¹
    this.data.push(newData)
    
    // V3: ä¸å¯å˜æ›´æ–°
    this.data = [...this.data, newData]
  }
}
```

## æœ€ä½³å®è·µ

### 1. Schema è®¾è®¡
- ä½¿ç”¨æœ‰æ„ä¹‰çš„èŠ‚ç‚¹ ID (`'#'` å­—æ®µ)
- ä¿æŒ Schema ç»“æ„æ¸…æ™°å’Œå±‚æ¬¡åŒ–
- åˆç†ä½¿ç”¨æ¡ä»¶æ¸²æŸ“é¿å…å¤æ‚åµŒå¥—

### 2. ç»„ä»¶æ³¨å†Œ
- ç»Ÿä¸€çš„ç»„ä»¶å‘½åçº¦å®š
- æŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡ç»„ä»¶
- ä½¿ç”¨ TypeScript ç±»å‹å®šä¹‰

### 3. æ€§èƒ½ä¼˜åŒ–
- é¿å…åœ¨ `'#if'` ä¸­è¿›è¡Œå¤æ‚è®¡ç®—
- ä½¿ç”¨è®¡ç®—å±æ€§ç¼“å­˜æ˜‚è´µæ“ä½œ
- åˆç†æ‹†åˆ†å¤§å‹ Schema

### 4. é”™è¯¯å¤„ç†
- æ€»æ˜¯æä¾› fallback ç»„ä»¶
- ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼
- æ·»åŠ é€‚å½“çš„é”™è¯¯è¾¹ç•Œ

## å¼€å‘å·¥å…·

### è°ƒè¯•
- React DevTools æŸ¥çœ‹ç»„ä»¶æ ‘
- æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ ViewNode çŠ¶æ€
- ä½¿ç”¨ `effect` è·Ÿè¸ªå“åº”å¼å˜åŒ–

### æ€§èƒ½åˆ†æ
- React Profiler åˆ†ææ¸²æŸ“æ€§èƒ½
- è§‚å¯Ÿ ViewNode æ›´æ–°é¢‘ç‡
- æ£€æŸ¥ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“

## ç¤ºä¾‹é¡¹ç›®

### Playground
```bash
cd playground
npm run dev:v3
# è®¿é—® http://localhost:9899
```

### å®Œæ•´åº”ç”¨ç¤ºä¾‹
å‚è€ƒ `playground/src/main-v3.tsx` æŸ¥çœ‹å®Œæ•´çš„åº”ç”¨ç¤ºä¾‹ï¼ŒåŒ…å«ï¼š
- åŸºç¡€ç»„ä»¶ä½¿ç”¨
- å“åº”å¼æ•°æ®æ¼”ç¤º
- è¡¨å•å¤„ç†
- æ¡ä»¶æ¸²æŸ“
- ç»„ä»¶åº“é›†æˆ

---

æ­¤æ–‡æ¡£ä¸º Eficy Core V3 çš„å®Œæ•´ LLM å‚è€ƒæ–‡æ¡£ï¼Œæ¶µç›–äº†æ¶æ„ã€APIã€ä½¿ç”¨æ–¹æ³•ã€æœ€ä½³å®è·µç­‰æ‰€æœ‰é‡è¦ä¿¡æ¯ã€‚ 